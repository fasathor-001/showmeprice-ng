==============================
FILE: .\src\hooks\useAdmin.ts
==============================

import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import { Business, ViolationLog } from '../types';

export function useAdmin() {
  const [stats, setStats] = useState({
      users: 0,
      products: 0,
      pending: 0,
      violations: 0
  });
  const [pendingBusinesses, setPendingBusinesses] = useState<Business[]>([]);
  const [violations, setViolations] = useState<ViolationLog[]>([]);
  const [loading, setLoading] = useState(true);

  // Initial Fetch
  useEffect(() => {
    if (!supabase) {
        setLoading(false);
        return;
    }
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
      setLoading(true);
      try {
          // 1. Fetch Counts
          const { count: userCount } = await supabase!.from('users').select('*', { count: 'exact', head: true });
          const { count: prodCount } = await supabase!.from('products').select('*', { count: 'exact', head: true }).eq('is_active', true);
          
          // 2. Fetch Pending Businesses
          const { data: pending } = await supabase!
              .from('businesses')
              .select('*, users!inner(full_name, email)') 
              .eq('verification_status', 'pending');
          
          // 3. Fetch Violations
          const { data: viols } = await supabase!
              .from('violation_logs')
              .select('*, users(full_name, email)')
              .order('created_at', { ascending: false });

          setStats({
              users: userCount || 0,
              products: prodCount || 0,
              pending: pending?.length || 0,
              violations: viols?.length || 0
          });

          if (pending) setPendingBusinesses(pending as any);
          if (viols) setViolations(viols as any);

      } catch (err) {
          console.error("Admin fetch error:", err);
      } finally {
          setLoading(false);
      }
  };

  const approveSeller = async (businessId: string) => {
      if (!supabase) return;
      try {
          const { error } = await supabase
              .from('businesses')
              .update({ 
                  verification_status: 'approved',
                  verification_tier: 'verified' 
              })
              .eq('id', businessId);
          
          if (error) throw error;
          fetchDashboardData();
          return true;
      } catch (err) {
          console.error("Error approving seller:", err);
          return false;
      }
  };

  const approveSellers = async (businessIds: string[]) => {
      if (!supabase || businessIds.length === 0) return;
      try {
          const { error } = await supabase
              .from('businesses')
              .update({ 
                  verification_status: 'approved',
                  verification_tier: 'verified' 
              })
              .in('id', businessIds);
          
          if (error) throw error;
          fetchDashboardData();
          return true;
      } catch (err) {
          console.error("Error bulk approving sellers:", err);
          return false;
      }
  };

  const rejectSeller = async (businessId: string) => {
      if (!supabase) return;
      try {
          const { error } = await supabase
              .from('businesses')
              .update({ verification_status: 'rejected' })
              .eq('id', businessId);
          
          if (error) throw error;
          fetchDashboardData();
          return true;
      } catch (err) {
          console.error("Error rejecting seller:", err);
          return false;
      }
  };

  // Hard Suspend: Rejects business AND deactivates all products immediately
  const suspendBusiness = async (businessId: string) => {
      if (!supabase) return false;
      try {
          // 1. Mark business as rejected
          const { error: bizError } = await supabase
              .from('businesses')
              .update({ verification_status: 'rejected' })
              .eq('id', businessId);
          
          if (bizError) throw bizError;

          // 2. Deactivate all their products
          // Note: RLS must allow admin to update products. Assuming admin role override or policy exists.
          const { error: prodError } = await supabase
              .from('products')
              .update({ is_active: false })
              .eq('business_id', businessId);

          if (prodError) console.warn("Could not auto-deactivate products (Check RLS):", prodError);
          
          fetchDashboardData();
          return true;
      } catch (err) {
          console.error("Error suspending business:", err);
          return false;
      }
  };

  const dismissViolation = async (logId: string) => {
      if (!supabase) return;
      try {
          const { error } = await supabase
              .from('violation_logs')
              .delete()
              .eq('id', logId);
          
          if (error) throw error;
          fetchDashboardData();
      } catch (err) {
          console.error("Error dismissing violation:", err);
      }
  };

  return {
      stats,
      pendingBusinesses,
      violations,
      loading,
      approveSeller,
      approveSellers,
      rejectSeller,
      suspendBusiness,
      dismissViolation,
      refresh: fetchDashboardData
  };
}


==============================
FILE: .\src\hooks\useFeatureFlags.ts
==============================

import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import { useAuth } from './useAuth';

export interface FeatureFlag {
  key: string;
  enabled: boolean;
  description: string;
  visible_to: 'all' | 'authenticated' | 'premium' | 'admin';
}

export interface FeatureFlagAudit {
    id: string;
    flag_key: string;
    changed_by: string;
    from_enabled: boolean;
    to_enabled: boolean;
    created_at: string;
    changer_email?: string;
    note?: string;
}

export function useFeatureFlags() {
  const { user } = useAuth();
  const [flags, setFlags] = useState<Record<string, boolean>>({});
  const [flagList, setFlagList] = useState<FeatureFlag[]>([]);
  const [auditLog, setAuditLog] = useState<FeatureFlagAudit[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchFlags = async () => {
    if (!supabase) return;
    try {
      const { data, error } = await supabase
        .from('feature_flags')
        .select('*')
        .order('key');
        
      if (error) throw error;
      
      const map: Record<string, boolean> = {};
      (data as FeatureFlag[]).forEach(f => {
          map[f.key] = f.enabled;
      });
      
      setFlags(map);
      setFlagList(data as FeatureFlag[]);
    } catch (err) {
      console.error("Error fetching feature flags:", err);
    } finally {
      setLoading(false);
    }
  };

  const fetchAuditLog = async () => {
      if (!supabase || !user) return;
      
      const { data, error } = await supabase
          .from('feature_flag_audit')
          .select('*, changed_by') 
          .order('created_at', { ascending: false })
          .limit(20);
      
      if (!error && data) {
          // Enrich with emails
          const enriched = await Promise.all(data.map(async (item: any) => {
             // We try to fetch user email; requires RLS allowing read on users table for admin
             const { data: uRows, error: uErr } = await supabase
              .from('users')
              .select('email')
              .eq('id', item.changed_by)
              .limit(1);

            if (uErr) console.warn('useFeatureFlags: changed_by email lookup failed', uErr);

            const changedByEmail = uRows?.[0]?.email ?? null; // null when not found
             return { ...item, changer_email: u?.email || 'Unknown User' };
          }));
          setAuditLog(enriched);
      }
  };

  const updateFlag = async (key: string, updates: { enabled?: boolean, visible_to?: string }) => {
      if (!supabase || !user) return false;
      const currentFlag = flagList.find(f => f.key === key);
      if (!currentFlag) return false;

      const newEnabled = updates.enabled ?? currentFlag.enabled;
      const newVisibleTo = updates.visible_to ?? currentFlag.visible_to;
      
      try {
          // 1. Update Flag
          const { error } = await supabase
              .from('feature_flags')
              .update({ 
                  enabled: newEnabled,
                  visible_to: newVisibleTo
               })
              .eq('key', key);
          
          if (error) throw error;

          // 2. Insert Audit Log
          let note = `Changed by ${user.email}`;
          if (updates.visible_to && updates.visible_to !== currentFlag.visible_to) {
              note += `. Visibility: ${currentFlag.visible_to} -> ${newVisibleTo}`;
          }

          await supabase.from('feature_flag_audit').insert({
              flag_key: key,
              changed_by: user.id,
              from_enabled: currentFlag.enabled,
              to_enabled: newEnabled,
              note: note
          });

          // 3. Update Local State
          setFlags(prev => ({ ...prev, [key]: newEnabled }));
          setFlagList(prev => prev.map(f => f.key === key ? { ...f, enabled: newEnabled, visible_to: newVisibleTo as any } : f));
          
          fetchAuditLog();
          return true;
      } catch (err: any) {
          console.error("Error updating flag:", err);
          alert(`Failed to update flag: ${err.message}`);
          return false;
      }
  };

  useEffect(() => {
    fetchFlags();
  }, []);

  const isEnabled = (key: string) => {
      // Default messaging to true safely if flags haven't loaded or DB is empty
      if (key === 'in_app_messaging_enabled') return flags[key] ?? true;
      // Default others to false during loading to prevent flash of content
      if (loading) return false;
      return flags[key] ?? false;
  };

  const canUserSee = (key: string, userContext: { role?: string, plan?: string, isAuthenticated: boolean }) => {
      const flag = flagList.find(f => f.key === key);
      if (!flag || !flag.enabled) return false;
      
      switch (flag.visible_to) {
          case 'all': return true;
          case 'authenticated': return userContext.isAuthenticated;
          case 'premium': return userContext.plan === 'pro' || userContext.plan === 'business';
          case 'admin': return userContext.role === 'admin';
          default: return true;
      }
  };

  return { 
      flags, 
      flagList, 
      auditLog, 
      loading, 
      isEnabled, 
      canUserSee,
      updateFlag,
      fetchAuditLog 
  };
}


==============================
FILE: .\src\pages\AdminDashboard.tsx
==============================

import React, { useState, useEffect } from 'react';
import { useAdmin } from '../hooks/useAdmin';
import { useProfile } from '../hooks/useProfile';
import { useAuth } from '../hooks/useAuth';
import AdminFeaturesPage from './AdminFeaturesPage';

interface AdminDashboardProps {
    onNavigateHome: () => void;
}

export default function AdminDashboard({ onNavigateHome }: AdminDashboardProps) {
    const { user } = useAuth();
    const { profile, loading: profileLoading } = useProfile();
    const { stats, pendingBusinesses, violations, loading: statsLoading, approveSeller, approveSellers, rejectSeller, suspendBusiness, dismissViolation } = useAdmin();
    
    const [activeTab, setActiveTab] = useState<'overview' | 'verification' | 'enforcement' | 'features'>('overview');
    const [selectedIds, setSelectedIds] = useState<string[]>([]);

    // Access Control
    useEffect(() => {
        if (!profileLoading && profile?.role !== 'admin') {
            // Force redirect or show denied message if not admin
            // We'll handle UI below, but this is a side-effect check
        }
    }, [profile, profileLoading]);

    // Logic for Bulk Selection
    const toggleSelectAll = () => {
        if (selectedIds.length === pendingBusinesses.length) {
            setSelectedIds([]);
        } else {
            setSelectedIds(pendingBusinesses.map((b: any) => b.id));
        }
    };

    const toggleSelect = (id: string) => {
        if (selectedIds.includes(id)) {
            setSelectedIds(selectedIds.filter(i => i !== id));
        } else {
            setSelectedIds([...selectedIds, id]);
        }
    };

    const handleBulkApprove = async () => {
        if (confirm(`Are you sure you want to verify ${selectedIds.length} sellers?`)) {
            await approveSellers(selectedIds);
            setSelectedIds([]);
        }
    };

    const parseContext = (context: string) => {
        try {
            return JSON.parse(context);
        } catch {
            return { raw: context };
        }
    };

    const handleSuspend = async (log: any) => {
        const parsed = parseContext(log.context);
        let businessId = parsed.businessId;

        if (!businessId) {
            alert(`Cannot auto-suspend: Business ID missing. Context: ${log.context}`);
            return;
        }

        if (confirm(`SUSPEND ${parsed.sellerName || 'Seller'}? This deactivates all products.`)) {
            const success = await suspendBusiness(businessId);
            if (success) {
                alert("Business suspended.");
                dismissViolation(log.id);
            }
        }
    };

    // Loading State
    if (statsLoading || profileLoading) {
        return (
            <div className="container mx-auto px-4 py-12 flex justify-center">
                <div className="skeleton w-full max-w-4xl h-96 rounded-xl"></div>
            </div>
        );
    }

    // Access Denied State
    if (!profile || profile.role !== 'admin') {
        return (
            <div className="container mx-auto px-4 py-20 text-center">
                <div className="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="shield-alert" className="w-10 h-10"></i>
                </div>
                <h1 className="text-3xl font-black text-slate-900 mb-2">Access Denied</h1>
                <p className="text-slate-500 mb-8">You do not have permission to view the Admin Panel.</p>
                <button onClick={onNavigateHome} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold">
                    Return Home
                </button>
            </div>
        );
    }

    return (
        <div className="bg-slate-50 min-h-screen pb-12">
            {/* Admin Header */}
            <div className="bg-slate-900 text-white py-6">
                <div className="container mx-auto px-4 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <div className="bg-emerald-500/20 p-2 rounded-lg border border-emerald-500/30">
                            <i data-lucide="shield-check" className="w-6 h-6 text-emerald-400"></i>
                        </div>
                        <div>
                            <h1 className="text-xl font-bold">Admin Panel</h1>
                            <p className="text-slate-400 text-xs">Platform Integrity & Configuration</p>
                        </div>
                    </div>
                    <button onClick={onNavigateHome} className="text-sm font-bold text-slate-300 hover:text-white flex items-center gap-2">
                        Exit <i data-lucide="log-out" className="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div className="container mx-auto px-4 -mt-8">
                <div className="bg-white rounded-xl shadow-lg border overflow-hidden flex flex-col md:flex-row min-h-[600px]">
                    
                    {/* Sidebar Tabs */}
                    <div className="w-full md:w-64 bg-slate-50 border-r flex-shrink-0">
                        <div className="p-4">
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Navigation</div>
                            <div className="space-y-1">
                                <button 
                                    onClick={() => setActiveTab('overview')}
                                    className={`w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3 transition ${activeTab === 'overview' ? 'bg-white text-slate-900 shadow-sm ring-1 ring-slate-200' : 'text-slate-500 hover:bg-slate-200/50'}`}
                                >
                                    <i data-lucide="layout-grid" className="w-4 h-4"></i> Overview
                                </button>
                                <button 
                                    onClick={() => setActiveTab('verification')}
                                    className={`w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3 transition ${activeTab === 'verification' ? 'bg-white text-slate-900 shadow-sm ring-1 ring-slate-200' : 'text-slate-500 hover:bg-slate-200/50'}`}
                                >
                                    <i data-lucide="badge-check" className="w-4 h-4"></i> Approvals
                                    {stats.pending > 0 && <span className="ml-auto bg-amber-500 text-white text-[10px] px-2 py-0.5 rounded-full">{stats.pending}</span>}
                                </button>
                                <button 
                                    onClick={() => setActiveTab('enforcement')}
                                    className={`w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3 transition ${activeTab === 'enforcement' ? 'bg-white text-slate-900 shadow-sm ring-1 ring-slate-200' : 'text-slate-500 hover:bg-slate-200/50'}`}
                                >
                                    <i data-lucide="alert-triangle" className="w-4 h-4"></i> Violations
                                    {stats.violations > 0 && <span className="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">{stats.violations}</span>}
                                </button>
                                <div className="border-t my-2 border-slate-200"></div>
                                <button 
                                    onClick={() => setActiveTab('features')}
                                    className={`w-full text-left px-4 py-3 rounded-lg text-sm font-bold flex items-center gap-3 transition ${activeTab === 'features' ? 'bg-white text-slate-900 shadow-sm ring-1 ring-slate-200' : 'text-slate-500 hover:bg-slate-200/50'}`}
                                >
                                    <i data-lucide="toggle-right" className="w-4 h-4"></i> Feature Flags
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        
                        {/* OVERVIEW TAB */}
                        {activeTab === 'overview' && (
                            <div className="animate-view">
                                <h2 className="text-2xl font-black text-slate-900 mb-6">System Status</h2>
                                
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                    <div className="p-4 bg-slate-50 rounded-xl border">
                                        <div className="text-slate-500 text-xs font-bold uppercase">Total Users</div>
                                        <div className="text-2xl font-black text-slate-900">{stats.users}</div>
                                    </div>
                                    <div className="p-4 bg-slate-50 rounded-xl border">
                                        <div className="text-slate-500 text-xs font-bold uppercase">Active Products</div>
                                        <div className="text-2xl font-black text-slate-900">{stats.products}</div>
                                    </div>
                                    <div className="p-4 bg-amber-50 border-amber-100 rounded-xl border">
                                        <div className="text-amber-600 text-xs font-bold uppercase">Pending Sellers</div>
                                        <div className="text-2xl font-black text-amber-700">{stats.pending}</div>
                                    </div>
                                    <div className="p-4 bg-red-50 border-red-100 rounded-xl border">
                                        <div className="text-red-600 text-xs font-bold uppercase">Active Reports</div>
                                        <div className="text-2xl font-black text-red-700">{stats.violations}</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VERIFICATION TAB */}
                        {activeTab === 'verification' && (
                            <div className="animate-view">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-black text-slate-900">Seller Approvals</h2>
                                    {selectedIds.length > 0 && (
                                        <button 
                                            onClick={handleBulkApprove}
                                            className="bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-emerald-600 shadow-sm flex items-center gap-2"
                                        >
                                            <i data-lucide="check-circle" className="w-4 h-4"></i>
                                            Approve Selected ({selectedIds.length})
                                        </button>
                                    )}
                                </div>
                                
                                {pendingBusinesses.length === 0 ? (
                                    <div className="text-center py-12 bg-slate-50 rounded-xl border border-dashed">
                                        <i data-lucide="check-circle" className="w-12 h-12 text-emerald-300 mx-auto mb-2"></i>
                                        <p className="text-slate-500 font-medium">All pending verifications cleared.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {pendingBusinesses.length > 0 && (
                                            <div className="flex items-center gap-3 p-2 bg-slate-50 rounded mb-2">
                                                <input 
                                                    type="checkbox" 
                                                    className="w-4 h-4"
                                                    checked={selectedIds.length === pendingBusinesses.length}
                                                    onChange={toggleSelectAll}
                                                />
                                                <span className="text-xs font-bold text-slate-500 uppercase">Select All</span>
                                            </div>
                                        )}
                                        {pendingBusinesses.map((biz: any) => (
                                            <div 
                                                key={biz.id} 
                                                className={`bg-white border p-4 rounded-xl flex flex-col md:flex-row md:items-center justify-between gap-4 shadow-sm hover:shadow-md transition ${selectedIds.includes(biz.id) ? 'ring-2 ring-emerald-500 bg-emerald-50/10' : ''}`}
                                            >
                                                <div className="flex items-start gap-4 flex-1">
                                                    <div className="pt-1">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-5 h-5 accent-brand rounded"
                                                            checked={selectedIds.includes(biz.id)}
                                                            onChange={() => toggleSelect(biz.id)}
                                                        />
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-slate-900">{biz.business_name}</h4>
                                                        <div className="text-sm text-slate-500 flex flex-col gap-1 mt-1">
                                                            <span className="flex items-center gap-1"><i data-lucide="user" className="w-3 h-3"></i> {biz.users?.full_name}</span>
                                                            <span className="flex items-center gap-1"><i data-lucide="map-pin" className="w-3 h-3"></i> {biz.city || 'Unknown City'}</span>
                                                            <span className="flex items-center gap-1"><i data-lucide="briefcase" className="w-3 h-3"></i> {biz.business_type}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 pl-9 md:pl-0">
                                                    <button onClick={() => rejectSeller(biz.id)} className="px-3 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100">Reject</button>
                                                    <button onClick={() => approveSeller(biz.id)} className="px-3 py-2 bg-emerald-500 text-white rounded-lg text-xs font-bold hover:bg-emerald-600">Approve</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ENFORCEMENT TAB */}
                        {activeTab === 'enforcement' && (
                            <div className="animate-view">
                                <h2 className="text-2xl font-black text-slate-900 mb-6">Trust & Safety Logs</h2>
                                
                                {violations.length === 0 ? (
                                    <div className="text-center py-12 bg-slate-50 rounded-xl border border-dashed">
                                        <i data-lucide="shield-check" className="w-12 h-12 text-blue-300 mx-auto mb-2"></i>
                                        <p className="text-slate-500 font-medium">No active violations detected.</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto border rounded-xl">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 border-b text-slate-500 font-bold uppercase text-xs">
                                                <tr>
                                                    <th className="px-6 py-3">Details</th>
                                                    <th className="px-6 py-3">Violation</th>
                                                    <th className="px-6 py-3 text-right">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {violations.map((log: any) => (
                                                    <tr key={log.id} className="hover:bg-slate-50">
                                                        <td className="px-6 py-4">
                                                            <div className="font-bold text-slate-900">{log.users?.full_name || 'System'}</div>
                                                            <div className="text-xs text-slate-400">{new Date(log.created_at).toLocaleDateString()}</div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <span className={`px-2 py-1 rounded text-xs font-bold border mb-1 inline-block ${
                                                                log.type === 'chat_contact_leak' 
                                                                    ? 'bg-amber-100 text-amber-700 border-amber-200' 
                                                                    : 'bg-red-100 text-red-700 border-red-200'
                                                            }`}>
                                                                {log.type === 'product_report' ? 'Product Flag' : 'Chat Policy'}
                                                            </span>
                                                            <div className="text-xs text-slate-600 font-mono bg-slate-100 p-1 rounded max-w-xs truncate">
                                                                {log.original_content}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 text-right">
                                                            <div className="flex justify-end gap-2">
                                                                {log.type === 'product_report' && (
                                                                    <button 
                                                                        onClick={() => handleSuspend(log)}
                                                                        className="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-xs font-bold border border-transparent hover:border-red-100"
                                                                    >
                                                                        Suspend
                                                                    </button>
                                                                )}
                                                                <button onClick={() => dismissViolation(log.id)} className="text-slate-500 hover:bg-slate-100 px-3 py-1 rounded text-xs font-bold">
                                                                    Dismiss
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* FEATURES TAB */}
                        {activeTab === 'features' && (
                            <AdminFeaturesPage />
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}


==============================
FILE: .\src\pages\AdminFeaturesPage.tsx
==============================

import React, { useEffect } from 'react';
import { useFeatureFlags } from '../hooks/useFeatureFlags';

export default function AdminFeaturesPage() {
    const { flagList, auditLog, loading, updateFlag, fetchAuditLog } = useFeatureFlags();

    useEffect(() => {
        fetchAuditLog();
    }, []);

    if (loading) return (
        <div className="p-12 text-center text-slate-500 flex flex-col items-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-brand mb-2"></div>
            Loading Configuration...
        </div>
    );

    return (
        <div className="animate-view space-y-8 max-w-4xl mx-auto">
            <div className="bg-white rounded-xl border p-6 shadow-sm">
                <div className="flex items-center justify-between mb-6">
                    <div>
                        <h2 className="text-xl font-black text-slate-900 flex items-center gap-2">
                            <i data-lucide="toggle-right" className="w-6 h-6 text-brand"></i>
                            Feature Toggles
                        </h2>
                        <p className="text-sm text-slate-500">Control platform features in real-time.</p>
                    </div>
                    <div className="text-xs font-bold bg-amber-100 text-amber-800 px-3 py-1 rounded-full border border-amber-200">
                        Admin Access Only
                    </div>
                </div>

                <div className="space-y-4">
                    {flagList.map(flag => (
                        <div key={flag.key} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-100 hover:border-slate-300 transition">
                            <div className="flex-1 pr-4">
                                <div className="font-bold text-slate-800 font-mono text-sm mb-1">{flag.key}</div>
                                <div className="text-xs text-slate-500">{flag.description}</div>
                                <div className="mt-2 flex gap-2 items-center">
                                    <span className="text-[10px] uppercase font-bold text-slate-400">Visible To:</span>
                                    <select 
                                        value={flag.visible_to}
                                        onChange={(e) => updateFlag(flag.key, { visible_to: e.target.value })}
                                        className="text-[10px] uppercase font-bold bg-slate-200 text-slate-700 px-2 py-0.5 rounded border-none focus:ring-1 focus:ring-brand cursor-pointer outline-none"
                                        disabled={flag.key === 'in_app_messaging_enabled'}
                                    >
                                        <option value="all">All</option>
                                        <option value="authenticated">Authenticated</option>
                                        <option value="premium">Premium</option>
                                        <option value="institution">Institution</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className={`text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider ${flag.enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-500'}`}>
                                    {flag.enabled ? 'Enabled' : 'Disabled'}
                                </span>
                                <label className="relative inline-flex items-center cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        className="sr-only peer"
                                        checked={flag.enabled}
                                        onChange={() => updateFlag(flag.key, { enabled: !flag.enabled })}
                                        disabled={flag.key === 'in_app_messaging_enabled'} // SAFETY LOCK
                                    />
                                    <div className="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand disabled:opacity-50 disabled:cursor-not-allowed"></div>
                                </label>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            <div className="bg-white rounded-xl border p-6 shadow-sm">
                <h2 className="text-xl font-black text-slate-900 mb-6 flex items-center gap-2">
                    <i data-lucide="history" className="w-5 h-5 text-slate-400"></i>
                    Audit Log (Last 20 Actions)
                </h2>
                <div className="overflow-x-auto">
                    <table className="w-full text-xs text-left">
                        <thead className="text-slate-500 bg-slate-50 uppercase font-bold">
                            <tr>
                                <th className="px-4 py-3">Time</th>
                                <th className="px-4 py-3">Admin User</th>
                                <th className="px-4 py-3">Feature Key</th>
                                <th className="px-4 py-3">Note</th>
                                <th className="px-4 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y">
                            {auditLog.length === 0 ? (
                                <tr>
                                    <td colSpan={5} className="px-4 py-8 text-center text-slate-400 font-medium">No recent changes recorded.</td>
                                </tr>
                            ) : (
                                auditLog.map((log) => (
                                    <tr key={log.id} className="hover:bg-slate-50">
                                        <td className="px-4 py-3 text-slate-500 font-mono">{new Date(log.created_at).toLocaleString()}</td>
                                        <td className="px-4 py-3 font-bold text-slate-900">{log.changer_email || 'Unknown'}</td>
                                        <td className="px-4 py-3 font-mono text-slate-600">{log.flag_key}</td>
                                        <td className="px-4 py-3 text-slate-500 italic max-w-xs truncate">{log.note}</td>
                                        <td className="px-4 py-3">
                                            <div className="flex items-center gap-2">
                                                <span className={`px-2 py-0.5 rounded ${log.from_enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                    {log.from_enabled ? 'ON' : 'OFF'}
                                                </span>
                                                <i data-lucide="arrow-right" className="w-3 h-3 text-slate-400"></i>
                                                <span className={`px-2 py-0.5 rounded ${log.to_enabled ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                    {log.to_enabled ? 'ON' : 'OFF'}
                                                </span>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}


==============================
FILE: .\src\pages\HomePage.tsx
==============================

import React, { useEffect, useState, FormEvent } from 'react';
import { useHubs } from '../hooks/useCategories';
import { useRecentProducts, useProductSearch, useSingleProduct } from '../hooks/useProducts';
import { useStates } from '../hooks/useStates';
import { useAuth } from '../hooks/useAuth';
import { ProductWithRelations } from '../types';
import PostProductForm from '../components/seller/PostProductForm';
import ProductDetail from '../components/product/ProductDetail';
import SellerDashboard from '../components/seller/SellerDashboard';
import PricingPage from './PricingPage';
import ProfilePage from './ProfilePage';
import InboxPage from './InboxPage';
import InstitutionPage from './InstitutionPage';
import AdminDashboard from './AdminDashboard';
import { supabase } from '../lib/supabase';
import SEO from '../components/common/SEO';

const CATEGORY_COLORS = [
  "text-blue-600",
  "text-emerald-600",
  "text-purple-600",
  "text-orange-600",
  "text-rose-600",
  "text-cyan-600",
  "text-indigo-600",
  "text-fuchsia-600",
  "text-lime-600",
  "text-amber-600",
  "text-teal-600",
  "text-violet-600"
];

export default function HomePage() {
  // --- Global Hooks ---
  const { signIn, signUp, resetPassword } = useAuth();
  const { fetchProduct } = useSingleProduct();
  
  // --- Modals State ---
  const [isRegisterOpen, setIsRegisterOpen] = useState(false);
  const [isAuthOpen, setIsAuthOpen] = useState(false);
  const [isForgotOpen, setIsForgotOpen] = useState(false);
  const [isProductOpen, setIsProductOpen] = useState(false);
  const [isPostItemOpen, setIsPostItemOpen] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState<ProductWithRelations | null>(null);

  // --- View Mode ---
  const [viewMode, setViewMode] = useState<'landing' | 'search' | 'dashboard' | 'pricing' | 'profile' | 'inbox' | 'institution' | 'admin'>('landing');
  
  // --- Inbox State ---
  const [inboxInitialChat, setInboxInitialChat] = useState<{ partnerId: string, productId: string | null, partnerName?: string, message?: string } | undefined>(undefined);

  // --- UI Toggles & Feedback ---
  const [userType, setUserType] = useState<'buyer' | 'seller'>('buyer');
  const [showPassword, setShowPassword] = useState<Record<string, boolean>>({});
  
  // EXACT STATE DECLARATIONS REQUESTED
  const [authError, setAuthError] = useState<string | null>(null);
  const [authLoading, setAuthLoading] = useState(false);
  const [forgotSuccess, setForgotSuccess] = useState(false);
  const [regSuccess, setRegSuccess] = useState(false);

  // --- Form States ---
  const [loginForm, setLoginForm] = useState({ email: '', password: '' });
  const [forgotEmail, setForgotEmail] = useState('');
  
  const [regForm, setRegForm] = useState({
    name: '',
    email: '',
    phone: '',
    state: '',
    city: '',
    password: '',
    confirmPassword: '',
    businessName: '',
    businessType: '',
    sellerState: '',
    sellerCity: '',
    terms: false
  });

  // --- Search Filter State ---
  const [priceInputs, setPriceInputs] = useState({ min: '', max: '' });

  // --- Data Hooks ---
  const { hubs, loading: hubsLoading } = useHubs();
  const { states, loading: statesLoading } = useStates();
  const { products: recentProducts, loading: recentLoading } = useRecentProducts();
  const { 
    results: searchResults, 
    loading: searchLoading, 
    hasMore, 
    params: searchParams, 
    updateParams, 
    triggerSearch, 
    loadMore 
  } = useProductSearch();

  // Initialize Lucide icons
  useEffect(() => {
    if ((window as any).lucide && typeof (window as any).lucide.createIcons === "function") {
      (window as any).lucide.createIcons();
    }
  }, [isRegisterOpen, isAuthOpen, isForgotOpen, isProductOpen, isPostItemOpen, hubs, recentProducts, searchResults, viewMode, authError, regSuccess]);

  // Deep Linking for Products
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const prodId = params.get('product');
    if (prodId && !selectedProduct) {
        fetchProduct(prodId).then(product => {
            if (product) {
                setSelectedProduct(product);
                setIsProductOpen(true);
            }
        });
    }
  }, []); // Run once on mount

  // Expose modal openers
  useEffect(() => {
      (window as any).openRegisterModal = () => { setIsRegisterOpen(true); setRegSuccess(false); setAuthError(null); };
      (window as any).openAuthModal = () => setIsAuthOpen(true);
      (window as any).openPostItemModal = () => setIsPostItemOpen(true);
      return () => {
          delete (window as any).openRegisterModal;
          delete (window as any).openAuthModal;
          delete (window as any).openPostItemModal;
      };
  }, []);

  // Event Listeners for Custom Navigation
  useEffect(() => {
      const handleDashboardNav = () => { setIsProductOpen(false); setViewMode('dashboard'); window.scrollTo(0,0); };
      const handlePricingNav = () => { setIsProductOpen(false); setViewMode('pricing'); window.scrollTo(0,0); };
      const handleProfileNav = () => { setIsProductOpen(false); setViewMode('profile'); window.scrollTo(0,0); };
      const handleInstitutionNav = () => { setIsProductOpen(false); setViewMode('institution'); window.scrollTo(0,0); };
      const handleAdminNav = () => { setIsProductOpen(false); setViewMode('admin'); window.scrollTo(0,0); };
      const handleInboxNav = (e: Event) => {
          setIsProductOpen(false); 
          const detail = (e as CustomEvent).detail;
          setInboxInitialChat(detail);
          setViewMode('inbox'); 
          window.scrollTo(0,0); 
      };
      
      window.addEventListener('smp:view-dashboard', handleDashboardNav);
      window.addEventListener('smp:view-pricing', handlePricingNav);
      window.addEventListener('smp:view-profile', handleProfileNav);
      window.addEventListener('smp:view-institution', handleInstitutionNav);
      window.addEventListener('smp:view-admin', handleAdminNav);
      window.addEventListener('smp:view-inbox', handleInboxNav);
      
      return () => {
          window.removeEventListener('smp:view-dashboard', handleDashboardNav);
          window.removeEventListener('smp:view-pricing', handlePricingNav);
          window.removeEventListener('smp:view-profile', handleProfileNav);
          window.removeEventListener('smp:view-institution', handleInstitutionNav);
          window.removeEventListener('smp:view-admin', handleAdminNav);
          window.removeEventListener('smp:view-inbox', handleInboxNav);
      };
  }, []);

  // --- UI Handlers ---
  const closeRegisterModal = () => { setIsRegisterOpen(false); setAuthError(null); setRegSuccess(false); };
  const closeAuthModal = () => { setIsAuthOpen(false); setAuthError(null); };
  const closeForgotPasswordModal = () => { setIsForgotOpen(false); setAuthError(null); };
  const closePostItemModal = () => setIsPostItemOpen(false);
  
  const selectUserType = (type: 'buyer' | 'seller') => setUserType(type);
  
  const togglePassword = (id: string) => {
    setShowPassword(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const switchToLogin = () => {
    setIsRegisterOpen(false);
    setIsAuthOpen(true);
    setAuthError(null);
    setRegSuccess(false);
  };
  
  const switchToRegister = () => {
    setIsAuthOpen(false);
    setIsRegisterOpen(true);
    setAuthError(null);
    setRegSuccess(false);
  };
  
  const switchToLoginFromForgot = () => {
    setIsForgotOpen(false);
    setIsAuthOpen(true);
    setAuthError(null);
  };
  
  const openForgotPasswordModal = () => {
    setIsAuthOpen(false);
    setForgotSuccess(false);
    setIsForgotOpen(true);
    setAuthError(null);
  };

  const openProductModal = (product: ProductWithRelations) => {
      setSelectedProduct(product);
      setIsProductOpen(true);
      const url = new URL(window.location.href);
      url.searchParams.set('product', product.id);
      window.history.pushState({}, '', url);
  };

  const closeProductModal = () => {
      setIsProductOpen(false);
      setTimeout(() => setSelectedProduct(null), 300);
      const url = new URL(window.location.href);
      url.searchParams.delete('product');
      window.history.pushState({}, '', url);
  };

  // --- Navigation Helper ---
  const navigateHome = () => {
    window.history.pushState({}, "", '/');
    window.dispatchEvent(new Event('smp:navigate'));
    
    setViewMode('landing');
    setInboxInitialChat(undefined);
    updateParams({
      query: '',
      hubIds: [],
      state: '',
      minPrice: '',
      maxPrice: '',
      sort: 'newest',
      page: 0
    });
    setPriceInputs({ min: '', max: '' });

    closeRegisterModal();
    closeAuthModal();
    closeForgotPasswordModal();
    closePostItemModal();
    window.scrollTo(0, 0);
  };

  // --- Auth Logic ---

  const handleRegister = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault(); 
    setAuthError(null);
    setAuthLoading(true);

    if (regForm.password !== regForm.confirmPassword) {
        setAuthError("Passwords do not match");
        setAuthLoading(false);
        return;
    }
    if (regForm.password.length < 6) {
        setAuthError("Password must be at least 6 characters");
        setAuthLoading(false);
        return;
    }

    try {
        let stateId = null;
        if (userType === 'seller' && regForm.sellerState) {
            // Updated logic: treat sellerState as ID string from value={state.id}
            const parsed = parseInt(regForm.sellerState, 10);
            if (Number.isFinite(parsed)) stateId = parsed;
        }

        const data = await signUp(regForm.email, regForm.password, {
            full_name: regForm.name,
            phone: regForm.phone,
            user_type: userType,
            business_name: regForm.businessName,
            business_type: regForm.businessType,
            city: regForm.sellerCity,
            state_id: stateId
        });

        // Response Handling
        if (data.user && !data.session) {
           // Email Confirmation Required
           setRegSuccess(true);
        } else if (data.session) {
           // Active Session
           closeRegisterModal();
           
           const isSeller = data.user?.user_metadata?.user_type === 'seller';
           if (isSeller) {
               setViewMode('dashboard');
               // NO SCROLL
           }
        }

    } catch (err: any) {
        console.error("Registration error:", err);
        setAuthError(err.message || "Failed to register. Please try again.");
    } finally {
        setAuthLoading(false);
    }
  };

  const handleLogin = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault(); 
    setAuthError(null);
    setAuthLoading(true);

    try {
        const data = await signIn(loginForm.email, loginForm.password);
        
        if (data.session) {
            closeAuthModal();
            // Check metadata to determine view mode
            if (data.user?.user_metadata?.user_type === 'seller') {
                setViewMode('dashboard');
                // NO SCROLL
            }
        }
    } catch (err: any) {
        console.error("Login error:", err);
        setAuthError(err.message || "Invalid email or password.");
    } finally {
        setAuthLoading(false);
    }
  };

  const handleForgotPassword = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setAuthError(null);
    setAuthLoading(true);
    try {
        await resetPassword(forgotEmail);
        setForgotSuccess(true);
    } catch (err: any) {
        setAuthError(err.message);
    } finally {
        setAuthLoading(false);
    }
  };

  // --- Search Actions ---
  const performMobileSearch = () => { setViewMode('search'); triggerSearch(); window.scrollTo(0,0); };
  const performHeroSearch = () => { setViewMode('search'); triggerSearch(); window.scrollTo(0,0); };
  const handleHubClick = (hubId: number) => { updateParams({ hubIds: [hubId] }); setViewMode('search'); triggerSearch(); window.scrollTo(0,0); };
  const applyPriceFilter = () => { updateParams({ minPrice: priceInputs.min, maxPrice: priceInputs.max }); triggerSearch(); };
  const sortResults = (e: React.ChangeEvent<HTMLSelectElement>) => { updateParams({ sort: e.target.value }); setTimeout(triggerSearch, 0); };
  const handleCategoryCheckbox = (e: React.ChangeEvent<HTMLInputElement>, hubId: number) => {
      const isChecked = e.target.checked;
      let newHubIds = [...searchParams.hubIds];
      if (isChecked) newHubIds.push(hubId); else newHubIds = newHubIds.filter(id => id !== hubId);
      updateParams({ hubIds: newHubIds }); setTimeout(triggerSearch, 0);
  };
  const handleMainSearch = (e: React.FormEvent) => { e.preventDefault(); triggerSearch(); };

  const handleViewAll = () => {
      updateParams({ query: '', hubIds: [], state: '' });
      setViewMode('search');
      setTimeout(() => {
          triggerSearch();
          window.scrollTo(0, 0);
      }, 0);
  };

  const getIconName = (name: string | null) => {
      if (!name) return 'folder';
      return name
          .replace(/([a-z0-9])([A-Z])/g, '$1-$2')
          .replace(/([A-Z])([A-Z][a-z])/g, '$1-$2')
          .toLowerCase()
          .replace(/^-/, '');
  };

  const renderProductCard = (product: ProductWithRelations) => {
    const tier = product.businesses?.verification_tier || 'basic';
    const isVerified = tier === 'verified' || tier === 'premium';
    const isPremium = tier === 'premium';
    
    const hasDiscount = product.original_price && product.original_price > product.price;
    const discountPercentage = hasDiscount 
      ? Math.round(((product.original_price! - product.price) / product.original_price!) * 100) 
      : 0;

    return (
      <div key={product.id} onClick={() => openProductModal(product)} className="bg-white border rounded-xl overflow-hidden hover:shadow-lg transition cursor-pointer group flex flex-col h-full">
          <div className="h-48 bg-slate-200 relative overflow-hidden flex-shrink-0">
              {product.images && product.images.length > 0 ? (
                  <img src={product.images[0]} alt={product.title} className="w-full h-full object-cover group-hover:scale-105 transition duration-500" />
              ) : (
                  <div className="w-full h-full flex items-center justify-center text-slate-400">
                      <i data-lucide="image" className="w-8 h-8"></i>
                  </div>
              )}
              <div className="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-bold text-slate-700 shadow-sm capitalize">
                  {product.condition}
              </div>
              {hasDiscount && (
                 <div className="absolute top-2 left-2 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold shadow-sm">
                    -{discountPercentage}%
                 </div>
              )}
          </div>
          <div className="p-4 flex flex-col flex-1">
              <div className="text-xs text-brand font-bold mb-1 uppercase tracking-wider truncate">{product.categories?.name || 'Item'}</div>
              <h3 className="font-bold text-slate-900 truncate mb-2 leading-tight">{product.title}</h3>
              
              <div className="mb-3">
                 <p className="text-brand font-black text-lg">{product.price.toLocaleString()}</p>
                 {hasDiscount && (
                   <p className="text-xs text-slate-400 line-through">{product.original_price!.toLocaleString()}</p>
                 )}
              </div>
              
              <div className="mt-auto pt-3 border-t border-slate-50 flex items-center justify-between text-xs text-slate-500">
                  <div className="flex items-center gap-1 min-w-0">
                       <i data-lucide="map-pin" className="w-3 h-3 flex-shrink-0"></i>
                       <span className="truncate max-w-[80px]">{product.states?.name || 'Nigeria'}</span>
                  </div>
                  <div className="flex items-center gap-1 min-w-0 relative">
                       {isVerified && (
                          <i data-lucide="badge-check" className={`w-3 h-3 flex-shrink-0 ${isPremium ? 'text-amber-500 fill-amber-500' : 'text-brand fill-brand text-white'}`}></i>
                       )}
                       <i data-lucide="store" className={`w-3 h-3 flex-shrink-0 ${!isVerified ? 'text-slate-400' : 'hidden'}`}></i>
                       <span className={`truncate max-w-[80px] ${isVerified ? 'text-slate-800 font-bold' : ''}`}>
                         {product.businesses?.business_name || 'Seller'}
                       </span>
                  </div>
              </div>
          </div>
      </div>
    );
  };

  return (
    <>
      {/* Default SEO for Landing Page */}
      {viewMode === 'landing' && <SEO />}
      {viewMode === 'search' && <SEO title={`Search Results: ${searchParams.query || 'All Products'}`} />}

      {/* Mobile Search Bar */}
      {viewMode !== 'dashboard' && viewMode !== 'pricing' && viewMode !== 'profile' && viewMode !== 'inbox' && viewMode !== 'institution' && viewMode !== 'admin' && (
        <div className="md:hidden bg-white border-b py-3 px-4">
            <div className="flex flex-col gap-2">
                <select 
                  id="mobileCategorySelect" 
                  className="w-full p-3 bg-slate-100 rounded-lg text-sm font-bold border outline-none"
                  value={searchParams.hubIds[0] || ''}
                  onChange={(e) => updateParams({ hubIds: e.target.value ? [parseInt(e.target.value)] : [] })}
                >
                    <option value="">All Categories</option>
                    {!hubsLoading && (hubs || []).map(hub => (
                      <option key={hub.id} value={hub.id}>{hub.name}</option>
                    ))}
                </select>
                
                <div className="flex bg-slate-100 rounded-xl overflow-hidden">
                    <input 
                      type="text" 
                      id="mobileSearchInput" 
                      placeholder="Search on ShowMePrice..." 
                      className="flex-1 px-4 py-3 bg-transparent outline-none text-sm"
                      value={searchParams.query}
                      onChange={(e) => updateParams({ query: e.target.value })}
                    />
                    <button onClick={performMobileSearch} className="bg-brand text-white px-4 py-3">
                        <i data-lucide="search" className="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
      )}

      {/* Hero Section (Visible only in Landing View) */}
      <div id="landingView" className={viewMode === 'landing' ? "animate-view" : "hidden"}>
          <div className="bg-gradient-to-b from-white to-slate-50 pt-12 pb-20 px-4">
              <div className="container mx-auto text-center">
                  <h1 className="text-4xl md:text-6xl font-black text-slate-900 mb-6 leading-tight">
                      Find <span className="text-brand">Real Prices</span> from<br />
                      <span className="text-brand">Verified</span> Nigerian Sellers
                  </h1>
                  <p className="text-slate-600 text-lg mb-10 max-w-2xl mx-auto">
                      No more "DM for price". See actual prices, contact sellers directly, and shop with confidence.
                  </p>
                  
                  {/* Main Search */}
                  <div className="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-2 border">
                      <div className="flex flex-col md:flex-row gap-2">
                          <select 
                            id="heroStateSelect" 
                            className="bg-slate-50 px-4 py-3 rounded-lg text-sm font-bold border outline-none w-full md:w-40"
                            value={searchParams.state}
                            onChange={(e) => updateParams({ state: e.target.value })}
                            disabled={statesLoading}
                          >
                              <option value="">All Nigeria</option>
                              {states.map(state => (
                                <option key={state.id} value={state.name}>{state.name}</option>
                              ))}
                          </select>
                          
                          {/* Adjusted width to w-48 as requested */}
                          <select 
                            id="heroCategorySelect" 
                            className="bg-slate-50 px-4 py-3 rounded-lg text-sm font-bold border outline-none w-full md:w-48 select-long-text"
                            value={searchParams.hubIds[0] || ''}
                            onChange={(e) => updateParams({ hubIds: e.target.value ? [parseInt(e.target.value)] : [] })}
                          >
                              <option value="">All Categories</option>
                              {!hubsLoading && (hubs || []).map(hub => (
                                <option key={hub.id} value={hub.id}>{hub.name}</option>
                              ))}
                          </select>
                          
                          <input 
                            type="text" 
                            id="heroSearchInput" 
                            placeholder="What are you looking for?" 
                            className="flex-1 px-4 py-3 text-lg outline-none min-w-0"
                            value={searchParams.query}
                            onChange={(e) => updateParams({ query: e.target.value })}
                          />
                          
                          <button onClick={performHeroSearch} className="bg-brand text-white px-8 py-3 rounded-lg font-black text-sm hover:opacity-90 whitespace-nowrap">
                              Search
                          </button>
                      </div>
                  </div>
              </div>
          </div>

          {/* Featured Categories */}
          <div className="container mx-auto px-4 py-12">
              <div className="flex justify-between items-center mb-8">
                  <h2 className="text-2xl font-black text-slate-900 text-center md:text-left">Browse Popular Categories</h2>
              </div>
              <div id="featuredCategories" className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                  {!hubsLoading && (hubs || []).slice(0, 8).map((hub) => {
                    const colorClass = CATEGORY_COLORS[hub.id % CATEGORY_COLORS.length] || "text-slate-600";
                    const iconName = getIconName(hub.icon_name);
                    return (
                      <div key={hub.id} onClick={() => handleHubClick(hub.id)} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer transition flex flex-col items-center text-center gap-3 group">
                          <div className="category-icon bg-transparent">
                               <i data-lucide={iconName} className={`w-8 h-8 ${colorClass}`}></i>
                          </div>
                          <span className="font-bold text-xs text-slate-700 leading-tight group-hover:text-brand transition">{hub.name}</span>
                      </div>
                    );
                  })}
              </div>
          </div>

          {/* Recent Listings */}
          <div className="container mx-auto px-4 py-8">
              <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-black text-slate-900">Recently Added</h2>
                  <button onClick={handleViewAll} className="text-brand font-bold text-sm hover:underline flex items-center gap-1">
                      View All <i data-lucide="arrow-right" className="w-4 h-4"></i>
                  </button>
              </div>
              <div id="recentListings" className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                  {recentLoading && (
                      <div className="col-span-full flex justify-center py-10">
                          <div className="skeleton w-32 h-32 rounded-lg"></div>
                      </div>
                  )}
                  {!recentLoading && recentProducts.length === 0 && (
                      <div className="col-span-full text-center py-10 text-slate-500">
                          No products found. Be the first to sell!
                      </div>
                  )}
                  {recentProducts.map(renderProductCard)}
              </div>
          </div>
      </div>

      {/* Search Results View (Visible only when Searching) */}
      <div id="searchView" className={viewMode === 'search' ? "container mx-auto px-4 py-8 animate-view" : "hidden"}>
          {/* ... Existing search layout ... */}
          <div className="flex flex-col md:flex-row gap-8">
              <aside className="w-full md:w-72">
                  <div className="bg-white rounded-xl shadow-sm border p-6 sticky top-24">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="font-black text-slate-900">Filters</h3>
                          <button onClick={() => setViewMode('landing')} className="text-xs text-brand font-bold hover:underline md:hidden">Back</button>
                      </div>
                      
                      {/* Sidebar Search */}
                      <div className="mb-6">
                           <div className="relative">
                               <input 
                                 type="text" 
                                 placeholder="Filter results..." 
                                 className="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-brand"
                                 value={searchParams.query}
                                 onChange={(e) => updateParams({ query: e.target.value })}
                               />
                               <i data-lucide="search" className="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                           </div>
                      </div>
                      
                      <div className="mb-6">
                          <h4 className="text-sm font-bold text-slate-700 mb-3">Location</h4>
                          <select 
                            id="filterState" 
                            className="w-full p-3 bg-slate-50 rounded-lg border text-sm"
                            value={searchParams.state}
                            onChange={(e) => { updateParams({ state: e.target.value }); setTimeout(triggerSearch, 0); }}
                            disabled={statesLoading}
                          >
                              <option value="">All States</option>
                              {states.map(state => (
                                <option key={state.id} value={state.name}>{state.name}</option>
                              ))}
                          </select>
                      </div>

                      <div className="mb-6">
                          <h4 className="text-sm font-bold text-slate-700 mb-3">Category</h4>
                          <div id="categoryFilter" className="space-y-2 max-h-96 overflow-y-auto pr-2">
                              {!hubsLoading && (hubs || []).map(hub => (
                                  <label key={hub.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-1 rounded">
                                      <input 
                                        type="checkbox" 
                                        className="rounded text-brand focus:ring-brand w-4 h-4" 
                                        checked={searchParams.hubIds.includes(hub.id)}
                                        onChange={(e) => handleCategoryCheckbox(e, hub.id)}
                                        value={hub.id} 
                                      />
                                      <span className="text-sm text-slate-600">{hub.name}</span>
                                  </label>
                              ))}
                          </div>
                      </div>

                      <div className="mb-6">
                          <h4 className="text-sm font-bold text-slate-700 mb-3">Price Range</h4>
                          <div className="flex gap-2">
                              <input 
                                type="number" 
                                id="minPrice" 
                                placeholder="Min " 
                                className="w-1/2 p-2 border rounded text-sm"
                                value={priceInputs.min}
                                onChange={(e) => setPriceInputs(p => ({ ...p, min: e.target.value }))}
                              />
                              <input 
                                type="number" 
                                id="maxPrice" 
                                placeholder="Max " 
                                className="w-1/2 p-2 border rounded text-sm"
                                value={priceInputs.max}
                                onChange={(e) => setPriceInputs(p => ({ ...p, max: e.target.value }))}
                              />
                          </div>
                          <button onClick={applyPriceFilter} className="w-full mt-3 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded-lg text-sm font-bold">
                              Apply Price
                          </button>
                      </div>
                      
                      <button onClick={() => setViewMode('landing')} className="w-full text-slate-400 text-sm hover:text-slate-600">
                          Clear & Go Home
                      </button>
                  </div>
              </aside>

              <div className="flex-1 min-w-0">
                  {/* Top Search Bar for Filter Page (Search View) */}
                  <div className="bg-white p-4 rounded-xl border shadow-sm mb-6">
                    <form onSubmit={handleMainSearch} className="flex gap-2">
                        <div className="relative flex-1">
                             <input 
                               type="text" 
                               placeholder="Search products..." 
                               className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-brand"
                               value={searchParams.query}
                               onChange={(e) => updateParams({ query: e.target.value })}
                             />
                             <i data-lucide="search" className="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        </div>
                        <button type="submit" className="bg-brand text-white px-6 py-2 rounded-lg font-bold text-sm hover:opacity-90">
                            Search
                        </button>
                    </form>
                  </div>

                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                      <h3 id="resultsTitle" className="text-xl font-black text-slate-900 truncate">
                          {searchLoading ? 'Searching...' : `Found ${searchResults.length} Results`}
                      </h3>
                      <div className="flex items-center gap-4">
                          <select 
                            id="sortBy" 
                            className="p-2 border rounded text-sm" 
                            onChange={sortResults} 
                            value={searchParams.sort}
                          >
                              <option value="newest">Newest First</option>
                              <option value="price_low">Price: Low to High</option>
                              <option value="price_high">Price: High to Low</option>
                          </select>
                      </div>
                  </div>
                  
                  {searchLoading && searchResults.length === 0 ? (
                      <div className="flex justify-center py-20">
                          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-brand"></div>
                      </div>
                  ) : (
                      <div id="resultsArea" className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                          {searchResults.map(renderProductCard)}
                      </div>
                  )}

                  {!searchLoading && searchResults.length === 0 && (
                      <div className="text-center py-16 bg-slate-50 rounded-xl border border-dashed">
                          <div className="mx-auto w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                              <i data-lucide="search-x" className="w-8 h-8 text-slate-400"></i>
                          </div>
                          <h3 className="text-lg font-bold text-slate-700">No products found</h3>
                          <p className="text-slate-500">Try adjusting your filters or search term.</p>
                      </div>
                  )}

                  <div id="loadMoreContainer" className={`text-center mt-8 ${hasMore ? '' : 'hidden'}`}>
                      <button onClick={loadMore} disabled={searchLoading} className="bg-brand text-white px-6 py-3 rounded-lg font-bold hover:opacity-90 disabled:opacity-50">
                          {searchLoading ? 'Loading...' : 'Load More Listings'}
                      </button>
                  </div>
              </div>
          </div>
      </div>

      {/* DASHBOARD VIEW */}
      {viewMode === 'dashboard' && (
          <SellerDashboard 
            onNavigateHome={() => setViewMode('landing')} 
            onPostProduct={() => setIsPostItemOpen(true)}
          />
      )}

      {/* PRICING VIEW */}
      {viewMode === 'pricing' && (
          <PricingPage onNavigateHome={() => setViewMode('landing')} />
      )}

      {/* PROFILE VIEW (Phase 8) */}
      {viewMode === 'profile' && (
          <ProfilePage onNavigateHome={() => setViewMode('landing')} />
      )}

      {/* INSTITUTION VIEW (Phase 3 Extra) */}
      {viewMode === 'institution' && (
          <InstitutionPage onNavigateHome={() => setViewMode('landing')} />
      )}

      {/* ADMIN DASHBOARD VIEW (Phase 4) */}
      {viewMode === 'admin' && (
          <AdminDashboard onNavigateHome={() => setViewMode('landing')} />
      )}

      {/* INBOX VIEW (Phase 9) */}
      {viewMode === 'inbox' && (
          <InboxPage 
            initialChat={inboxInitialChat} 
            onNavigateHome={() => setViewMode('landing')} 
          />
      )}

      {/* Registration Modal - REDESIGNED & FIXED SCROLL */}
      <div id="registerModal" className={`fixed inset-0 z-[100] modal-overlay items-center justify-center p-4 flex ${isRegisterOpen ? '' : 'hidden'}`}>
          <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl animate-view max-h-[90vh] flex flex-col overflow-hidden">
              {/* Header (Fixed) */}
              <div className="bg-brand text-white p-6 rounded-t-2xl text-center relative flex-shrink-0">
                  <button onClick={closeRegisterModal} className="absolute top-4 right-4 text-white/80 hover:text-white"><i data-lucide="x" className="w-5 h-5"></i></button>
                  <div className="flex items-center justify-center gap-2 mb-2 cursor-pointer hover:opacity-90 transition" onClick={navigateHome}>
                       <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-brand font-bold text-xs">SMP</div>
                       <span className="font-bold text-xl">ShowMePrice.ng</span>
                  </div>
                  <p className="text-brand-50 text-sm">Join Nigeria's trusted marketplace</p>
              </div>

              {/* Body (Scrollable) */}
              <div className="p-8 overflow-y-auto flex-1 custom-scrollbar">
                  {regSuccess ? (
                      <div className="text-center py-10">
                          <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                              <i data-lucide="mail" className="w-8 h-8"></i>
                          </div>
                          <h3 className="text-xl font-bold text-slate-900 mb-2">Check your email</h3>
                          <p className="text-slate-600 mb-6 text-sm leading-relaxed">
                              We've sent a confirmation link to <strong>{regForm.email}</strong>.<br/>
                              Please click the link to activate your account.
                          </p>
                          <button onClick={switchToLogin} className="bg-brand text-white px-6 py-3 rounded-lg font-bold text-sm w-full hover:opacity-90">
                              Proceed to Login
                          </button>
                      </div>
                  ) : (
                      <>
                          <h2 className="text-xl font-bold text-slate-900 mb-1">Create your account</h2>
                          <p className="text-slate-500 text-sm mb-6">Get started with verified buying & selling</p>

                          {authError && (
                              <div className="mb-4 p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-lg flex items-center gap-2">
                                  <i data-lucide="alert-circle" className="w-4 h-4"></i>{authError}
                              </div>
                          )}

                          <div className="grid grid-cols-2 gap-4 mb-6">
                              <button type="button" onClick={() => selectUserType('buyer')} 
                                      className={`p-3 border rounded-lg text-center flex items-center justify-center gap-2 transition ${userType === 'buyer' ? 'border-blue-600 text-blue-600 bg-blue-50 ring-1 ring-blue-600' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                  <i data-lucide="shopping-cart" className="w-4 h-4"></i>
                                  <span className="font-bold text-sm">I'm a Buyer</span>
                              </button>
                              <button type="button" onClick={() => selectUserType('seller')} 
                                      className={`p-3 border rounded-lg text-center flex items-center justify-center gap-2 transition ${userType === 'seller' ? 'border-green-600 text-green-600 bg-green-50 ring-1 ring-green-600' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                  <i data-lucide="store" className="w-4 h-4"></i>
                                  <span className="font-bold text-sm">I'm a Seller</span>
                              </button>
                          </div>

                          <form onSubmit={handleRegister} className="space-y-4">
                              <div>
                                  <label className="text-xs font-bold text-slate-600 mb-1 block">Full Name</label>
                                  <input type="text" placeholder="John Doe" className="form-control" required value={regForm.name} onChange={(e) => setRegForm({...regForm, name: e.target.value})} />
                              </div>
                              
                              <div>
                                  <label className="text-xs font-bold text-slate-600 mb-1 block">Email Address</label>
                                  <input type="email" placeholder="you@example.com" className="form-control" required value={regForm.email} onChange={(e) => setRegForm({...regForm, email: e.target.value})} />
                              </div>
                              
                              <div>
                                  <label className="text-xs font-bold text-slate-600 mb-1 block">Phone Number</label>
                                  <input type="tel" placeholder="+234 801 234 5678" className="form-control" required value={regForm.phone} onChange={(e) => setRegForm({...regForm, phone: e.target.value})} />
                              </div>

                              <div>
                                  <label className="text-xs font-bold text-slate-600 mb-1 block">Password</label>
                                  <div className="password-wrapper">
                                      <input type={showPassword['regPassword'] ? 'text' : 'password'} placeholder="Create a strong password" 
                                         className="form-control" required
                                         value={regForm.password} 
                                         onChange={(e) => setRegForm({...regForm, password: e.target.value})} />
                                      <button type="button" className="password-toggle" onClick={() => togglePassword('regPassword')}>
                                          <i data-lucide="eye" className="w-4 h-4"></i>
                                      </button>
                                  </div>
                              </div>

                              <div>
                                  <label className="text-xs font-bold text-slate-600 mb-1 block">Confirm Password</label>
                                  <div className="password-wrapper">
                                      <input type={showPassword['regConfirmPassword'] ? 'text' : 'password'} placeholder="Confirm your password" 
                                         className="form-control" required
                                         value={regForm.confirmPassword} 
                                         onChange={(e) => setRegForm({...regForm, confirmPassword: e.target.value})} />
                                      <button type="button" className="password-toggle" onClick={() => togglePassword('regConfirmPassword')}>
                                          <i data-lucide="eye" className="w-4 h-4"></i>
                                      </button>
                                  </div>
                              </div>

                              {userType === 'seller' && (
                                  <div className="border-2 border-dashed border-slate-200 rounded-xl p-4 bg-slate-50 mt-4">
                                      <h4 className="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">
                                          <svg className="w-4 h-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m8-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2m7-2a9 9 0 01-18 0" />
                                          </svg>
                                          Seller Information
                                      </h4>
                                      <div className="space-y-3">
                                          <div>
                                             <label className="text-xs font-bold text-slate-600 mb-1 block">Business Name</label>
                                             <input type="text" placeholder="Your Business Name" className="form-control" value={regForm.businessName} onChange={(e) => setRegForm({...regForm, businessName: e.target.value})} />
                                          </div>
                                          <div>
                                             <label className="text-xs font-bold text-slate-600 mb-1 block">Business Type</label>
                                             <select className="form-control" value={regForm.businessType} onChange={(e) => setRegForm({...regForm, businessType: e.target.value})}>
                                                  <option value="">Select business type</option>
                                                  <option value="individual">Individual Seller</option>
                                                  <option value="registered">Registered Business</option>
                                             </select>
                                          </div>
                                          <div>
                                             <label className="text-xs font-bold text-slate-600 mb-1 block">Business Location</label>
                                             <select 
                                                className="form-control" 
                                                required={userType === 'seller'} 
                                                disabled={statesLoading} 
                                                value={regForm.sellerState} 
                                                onChange={(e) => setRegForm({...regForm, sellerState: e.target.value})}
                                             >
                                                  <option value="">Select State in Nigeria</option>
                                                  {states.map(state => (<option key={state.id} value={state.id}>{state.name}</option>))}
                                             </select>
                                          </div>
                                          <div>
                                             <label className="text-xs font-bold text-slate-600 mb-1 block">City / Town</label>
                                             <input type="text" placeholder="e.g., Ikeja, Surulere, Gwarinpa" className="form-control" value={regForm.sellerCity} onChange={(e) => setRegForm({...regForm, sellerCity: e.target.value})} />
                                          </div>
                                      </div>
                                  </div>
                              )}

                              <div className="flex items-start gap-3 mt-4">
                                  <input type="checkbox" id="regTerms" className="w-4 h-4 mt-1 accent-brand" required checked={regForm.terms} onChange={(e) => setRegForm({...regForm, terms: e.target.checked})} />
                                  <label htmlFor="regTerms" className="text-slate-500 text-xs leading-relaxed">
                                      I agree to the <a href="#" className="text-brand font-bold hover:underline">Terms of Service</a> and <a href="#" className="text-brand font-bold hover:underline">Privacy Policy</a>.
                                      I confirm that I am at least 18 years old.
                                  </label>
                              </div>

                              <button type="submit" disabled={authLoading} className="w-full bg-brand text-white py-3 rounded-lg font-bold text-sm hover:opacity-90 transition shadow-sm mt-2 disabled:opacity-50">
                                  {authLoading ? 'Creating Account...' : 'Create Account'}
                              </button>
                          </form>

                          <div className="text-center mt-6 pt-6 border-t border-slate-100">
                              <p className="text-slate-500 text-sm">
                                  Already have an account? 
                                  <button onClick={switchToLogin} className="text-brand font-bold hover:underline ml-1">Sign in</button>
                              </p>
                              <button onClick={navigateHome} className="text-brand font-bold text-sm hover:underline mt-4 block mx-auto">Back to Homepage</button>
                          </div>
                      </>
                  )}
              </div>
          </div>
      </div>

      {/* Login Modal - REDESIGNED */}
      <div id="authModal" className={`fixed inset-0 z-[100] modal-overlay items-center justify-center p-4 ${isAuthOpen ? 'flex' : 'hidden'}`}>
          <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl animate-view">
              <div className="bg-brand text-white p-6 rounded-t-2xl text-center relative">
                  <button onClick={closeAuthModal} className="absolute top-4 right-4 text-white/80 hover:text-white"><i data-lucide="x" className="w-5 h-5"></i></button>
                  <div className="flex items-center justify-center gap-2 mb-2 cursor-pointer hover:opacity-90 transition" onClick={navigateHome}>
                       <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-brand font-bold text-xs">SMP</div>
                       <span className="font-bold text-xl">ShowMePrice.ng</span>
                  </div>
                  <p className="text-brand-50 text-sm">Welcome back to Nigeria's trusted marketplace</p>
              </div>

              <div className="p-8">
                  <h2 className="text-xl font-bold text-slate-900 mb-1">Sign in to your account</h2>
                  <p className="text-slate-500 text-sm mb-6">Enter your credentials to continue</p>
                  
                  {authError && (
                      <div className="mb-4 p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-lg flex items-center gap-2">
                          <i data-lucide="alert-circle" className="w-4 h-4"></i>{authError}
                      </div>
                  )}

                  <div className={`success-message ${forgotSuccess ? 'active' : ''}`} id="loginSuccessMessage">
                      <i data-lucide="check-circle" className="w-5 h-5"></i>
                      <span>Reset instructions sent! Check your email.</span>
                  </div>

                  <form onSubmit={handleLogin} className="space-y-4">
                      <div>
                          <label className="text-xs font-bold text-slate-600 mb-1 block">Email Address</label>
                          <input type="email" placeholder="you@example.com" className="form-control" required value={loginForm.email} onChange={(e) => setLoginForm({...loginForm, email: e.target.value})} />
                      </div>
                      
                      <div>
                          <label className="text-xs font-bold text-slate-600 mb-1 block">Password</label>
                          <div className="password-wrapper">
                              <input type={showPassword['loginPassword'] ? 'text' : 'password'} placeholder="Enter your password" 
                                     className="form-control" required
                                     value={loginForm.password}
                                     onChange={(e) => setLoginForm({...loginForm, password: e.target.value})} />
                              <button type="button" className="password-toggle" onClick={() => togglePassword('loginPassword')}>
                                  <i data-lucide="eye" className="w-4 h-4"></i>
                              </button>
                          </div>
                      </div>

                      <div className="flex justify-between items-center">
                          <label className="flex items-center gap-2 text-sm text-slate-600">
                              <input type="checkbox" id="rememberMe" className="w-4 h-4 accent-brand" />
                              Remember me
                          </label>
                          <button type="button" onClick={openForgotPasswordModal} className="text-brand font-bold text-sm hover:underline">
                              Forgot password?
                          </button>
                      </div>

                      <button type="submit" disabled={authLoading} className="w-full bg-brand text-white py-3 rounded-lg font-bold text-sm hover:opacity-90 transition mt-2 disabled:opacity-50">
                          {authLoading ? 'Signing In...' : 'Sign In'}
                      </button>
                  </form>

                  <div className="flex items-center my-6">
                      <div className="flex-1 border-t border-slate-200"></div>
                      <span className="px-4 text-slate-400 text-xs">Or continue with</span>
                      <div className="flex-1 border-t border-slate-200"></div>
                  </div>

                  <div className="grid grid-cols-2 gap-3 mb-6">
                      <button className="flex items-center justify-center gap-2 border border-slate-200 py-2.5 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition">
                          <svg className="w-5 h-5" viewBox="0 0 24 24">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" />
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
                          </svg>
                          Google
                      </button>
                      <button className="flex items-center justify-center gap-2 border border-slate-200 py-2.5 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition">
                          <svg className="w-5 h-5 text-[#1877F2]" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 2.848-5.978 5.817-5.978.953 0 1.905.045 2.857.135v3.42h-1.637c-1.372 0-2.327.947-2.327 2.75v1.253h5.051l-.707 3.667h-4.344v7.98H9.101z" />
                          </svg>
                          Facebook
                      </button>
                  </div>

                  <div className="text-center">
                      <p className="text-slate-500 text-sm">
                          Don't have an account? 
                          <button onClick={switchToRegister} className="text-brand font-bold hover:underline ml-1">Create account</button>
                      </p>
                      <button onClick={navigateHome} className="text-brand font-bold text-sm hover:underline mt-4 block mx-auto">Back to Homepage</button>
                  </div>
              </div>
          </div>
      </div>

      {/* Forgot Password Modal - REDESIGNED */}
      <div id="forgotPasswordModal" className={`fixed inset-0 z-[100] modal-overlay items-center justify-center p-4 ${isForgotOpen ? 'flex' : 'hidden'}`}>
          <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl animate-view">
              <div className="bg-brand text-white p-6 rounded-t-2xl text-center relative">
                   <button onClick={closeForgotPasswordModal} className="absolute top-4 right-4 text-white/80 hover:text-white"><i data-lucide="x" className="w-5 h-5"></i></button>
                   <div className="flex items-center justify-center gap-2 mb-2 cursor-pointer hover:opacity-90 transition" onClick={navigateHome}>
                       <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-brand font-bold text-xs">SMP</div>
                       <span className="font-bold text-xl">ShowMePrice.ng</span>
                  </div>
              </div>
              <div className="p-8 text-center">
                  <div className="w-16 h-16 bg-brand/10 text-brand rounded-full flex items-center justify-center mx-auto mb-4">
                      <i data-lucide="key" className="w-8 h-8"></i>
                  </div>
                  <h2 className="text-xl font-black text-slate-900 mb-2">Reset your password</h2>
                  <p className="text-slate-500 text-sm mb-6 max-w-xs mx-auto">Enter your email address and we'll send you instructions to reset your password.</p>
                  
                  {forgotSuccess ? <div className="p-3 bg-green-50 text-green-700 rounded-lg text-sm font-bold mb-4">Check your email for the reset link!</div> : (
                      <form onSubmit={handleForgotPassword} className="space-y-4 text-left">
                          <div>
                              <label className="text-xs font-bold text-slate-600 mb-1 block">Email Address</label>
                              <input type="email" placeholder="you@example.com" className="form-control" required value={forgotEmail} onChange={(e) => setForgotEmail(e.target.value)} />
                          </div>
                          <button type="submit" disabled={authLoading} className="w-full bg-brand text-white py-3 rounded-lg font-bold text-sm hover:opacity-90 transition">
                             {authLoading ? 'Sending...' : 'Send Reset Instructions'}
                          </button>
                      </form>
                  )}
                  <div className="text-center mt-6">
                      <p className="text-slate-500 text-sm">
                          Remember your password? <button onClick={switchToLoginFromForgot} className="text-brand font-bold hover:underline">Back to Sign in</button>
                      </p>
                      <button onClick={navigateHome} className="text-brand font-bold text-sm hover:underline mt-4 block mx-auto">Back to Homepage</button>
                  </div>
              </div>
          </div>
      </div>

      {/* Post Product Modal */}
      <div id="postProductModal" className={`fixed inset-0 z-[100] modal-overlay items-center justify-center p-4 ${isPostItemOpen ? 'flex' : 'hidden'}`}>
          <div className="w-full max-w-2xl relative animate-view max-h-[90vh] overflow-y-auto">
              <button onClick={closePostItemModal} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 z-10 p-2 bg-white rounded-full shadow-sm">
                  <i data-lucide="x" className="w-5 h-5"></i>
              </button>
              <PostProductForm />
          </div>
      </div>

      {/* Product Detail Modal */}
      <div id="productModal" className={`fixed inset-0 z-[100] modal-overlay items-center justify-center p-4 ${isProductOpen ? 'flex' : 'hidden'}`}>
          <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl animate-view max-h-[90vh] overflow-hidden">
             {selectedProduct && (
                 <ProductDetail product={selectedProduct} onClose={closeProductModal} />
             )}
          </div>
      </div>
    </>
  );
}


